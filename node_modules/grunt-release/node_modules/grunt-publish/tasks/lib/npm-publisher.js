var npm = require('npm');
var npmi = require('npmi');

/**
 * Created by leiko on 07/03/14.
 */
module.exports = function (filepath, options, callback) {
    if (!callback) {
        callback = options;
        options = {};
    }

    function publishModule() {
        // load npm
        npm.load({ loglevel: 'silent' }, function (err) {
            if (err) {
                return callback(err);
            }

            if (options.registry) {
                npm.config.set('registry', options.registry);
            }

            // npm publish
            npm.commands.publish([filepath], function (err) {
                if (err) {
                    return callback(err);
                }

                callback();
            });
        });
    }

    if (options.installBefore) {
        npmi({path: filepath, forceInstall: options.forceInstall}, function (err) {
            if (err) {
                callback(err);
                return;
            }

            publishModule();
        });
    } else {
        publishModule();
    }
};